name: Monitor Render Deployment

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  monitor-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest deploy ID
        id: get_deploy_id
        run: |
          # ìµœì‹  ë°°í¬ ID ê°€ì ¸ì˜¤ê¸°
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys)

          DEPLOY_ID=$(echo $RESPONSE | jq -r '.[0].id')
          echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_ENV

          # ë°°í¬ ì‹œì‘ ì•Œë¦¼
          curl -X POST -H "Content-type: application/json" \
          --data "{\"text\":\"ğŸ”„ ë°°í¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë°°í¬ ID: $DEPLOY_ID\"}" \
          "${{ secrets.SWIT_WEBHOOK_URL }}"

      - name: Wait and check deployment status
        run: |
          # ë°°í¬ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
          check_status() {
            curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys/${{ env.DEPLOY_ID }}
          }

          # ìµœëŒ€ 20ë¶„ ë™ì•ˆ ë°°í¬ ìƒíƒœ í™•ì¸ (30ì´ˆ ê°„ê²©)
          MAX_ATTEMPTS=40
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Checking deployment status (attempt $ATTEMPT/$MAX_ATTEMPTS)..."
            DEPLOY_INFO=$(check_status)
            STATUS=$(echo $DEPLOY_INFO | jq -r '.status')
            
            if [ "$STATUS" = "live" ]; then
              # ë°°í¬ ì„±ê³µ
              FINISH_TIME=$(echo $DEPLOY_INFO | jq -r '.finishedAt')
              COMMIT_MSG=$(echo $DEPLOY_INFO | jq -r '.commit.message')
              
              curl -X POST -H "Content-type: application/json" \
              --data "{\"text\":\"âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n- ì™„ë£Œ ì‹œê°„: $FINISH_TIME\n- ì»¤ë°‹ ë©”ì‹œì§€: $COMMIT_MSG\"}" \
              "${{ secrets.SWIT_WEBHOOK_URL }}"
              exit 0
              
            elif [ "$STATUS" = "build_failed" ] || [ "$STATUS" = "deactivated" ] || [ "$STATUS" = "canceled" ]; then
              # ë°°í¬ ì‹¤íŒ¨
              ERROR=$(echo $DEPLOY_INFO | jq -r '.errorMessage // "ìƒì„¸ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤."')
              
              curl -X POST -H "Content-type: application/json" \
              --data "{\"text\":\"âŒ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n- ìƒíƒœ: $STATUS\n- ì˜¤ë¥˜ ë©”ì‹œì§€: $ERROR\"}" \
              "${{ secrets.SWIT_WEBHOOK_URL }}"
              exit 1
              
            else
              # ì•„ì§ ì§„í–‰ ì¤‘ì¸ ìƒíƒœ (creating, build_in_progress ë“±)
              echo "Deployment still in progress. Status: $STATUS"
              sleep 30
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done

          # ì‹œê°„ ì´ˆê³¼
          curl -X POST -H "Content-type: application/json" \
          --data "{\"text\":\"âš ï¸ ë°°í¬ ìƒíƒœ í™•ì¸ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. Render ëŒ€ì‹œë³´ë“œì—ì„œ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.\"}" \
          "${{ secrets.SWIT_WEBHOOK_URL }}"
          exit 1
